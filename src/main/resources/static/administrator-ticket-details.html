<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Administrator - Ticket Details</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="system-name">IT Support Ticket System</div>
<nav>
    <a href="administrator-create-ticket.html">Create Ticket</a> |
    <a href="administrator-view-tickets.html">View Tickets</a> |
    <a href="admin-user-management.html">User Management</a> |
    <a href="admin-department-management.html">Department Management</a> |
    <a href="profile.html">Profile</a> |
    <a href="login.html" onclick="logout()">Logout</a>
</nav>

<div class="container">
    <h2 id="ticketTitle">Ticket Details</h2>
    <p><b>Created By:</b> <span id="createdBy"></span></p>
    <p><b>Category:</b> <span id="ticketCategory"></span></p>
    <p><b>Description:</b> <span id="ticketDescription"></span></p>
    <p><b>Priority:</b> <span id="ticketPriority"></span></p>
    <p><b>Status:</b> <span id="ticketStatus"></span></p>

    <h3>Attachments</h3>
    <ul id="attachments"></ul>

    <h3>Comments</h3>
    <ul id="commentList"></ul>
    <textarea id="commentText" placeholder="Write a comment..."></textarea>
    <button onclick="addComment()">Add Comment</button>

    <h3>Change Status</h3>
    <label>Status</label>
    <select id="statusSelect"></select>
    <button onclick="updateStatus()">Update Ticket</button>

    <h3>Assign Agent</h3>
    <select id="agentSelect"></select>
    <button onclick="assignTicket()">Assign</button>

    <p id="message"></p>
</div>

<script>
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("userId");
    const ticketId = localStorage.getItem("selectedTicketId");

    if (!token || !ticketId) window.location.href = "login.html";

    async function loadTicket() {
      const res = await fetch("http://localhost:8080/api/tickets/" + ticketId, {
        headers: { "Authorization": "Bearer " + token }
      });
      const ticket = await res.json();

      document.getElementById("ticketTitle").innerText = ticket.title;
      document.getElementById("createdBy").innerText = ticket.createdBy ? ticket.createdBy.firstName + " " + ticket.createdBy.lastName : "-";
      document.getElementById("ticketCategory").innerText = ticket.category ? ticket.category.name : "-";
      document.getElementById("ticketDescription").innerText = ticket.description;
      document.getElementById("ticketPriority").innerText = ticket.priority ? ticket.priority.name : "-";
      document.getElementById("ticketStatus").innerText = ticket.status ? ticket.status.name : "-";

      // Load attachments
      const resAttach = await fetch(`http://localhost:8080/api/attachments/ticket/${ticketId}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const attachments = await resAttach.json();
      const attachList = document.getElementById("attachments");
      attachList.innerHTML = "";
      if (attachments.length === 0) {
        attachList.innerHTML = "<li>No attachments</li>";
      } else {
        attachments.forEach(a => {
          attachList.innerHTML += `<li><a href="http://localhost:8080/attachments/${a.storedFileName}" target="_blank">${a.originalFileName}</a></li>`;
        });
      }

      loadComments();
      loadStatuses();
      loadAgents();
    }

    async function loadComments() {
      const res = await fetch(`http://localhost:8080/api/ticket-comments/ticket/${ticketId}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const comments = await res.json();
      const list = document.getElementById("commentList");
      list.innerHTML = "";
      if (comments.length === 0) {
        list.innerHTML = "<li>No comments yet</li>";
      } else {
        comments.forEach(c => {
          list.innerHTML += `<li><b>${c.author.firstName} ${c.author.lastName}:</b> ${c.content} <i>(${new Date(c.createdAt).toLocaleString()})</i></li>`;
        });
      }
    }

    async function addComment() {
      const content = document.getElementById("commentText").value.trim();
      if (!content) return;

      const res = await fetch("http://localhost:8080/api/ticket-comments", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
          ticketId: ticketId,
          authorId: userId,
          content: content,
          isInternal: false
        })
      });

      if (res.ok) {
        document.getElementById("commentText").value = "";
        loadComments();
      } else {
        document.getElementById("message").innerText = "Failed to add comment";
      }
    }

    async function loadStatuses() {
      const statusRes = await fetch("http://localhost:8080/api/statuses", {
        headers: { "Authorization": "Bearer " + token }
      });
      const statuses = await statusRes.json();
      const statusSelect = document.getElementById("statusSelect");
      statusSelect.innerHTML = "";
      statuses.forEach(s => {
        statusSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`;
      });
    }

    async function updateStatus() {
      const statusName = document.getElementById("statusSelect").value;

      const res = await fetch(`http://localhost:8080/api/tickets/${ticketId}/status`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ statusName })
      });

      if (res.ok) {
        document.getElementById("message").innerText = "Ticket status updated successfully!";
        loadTicket();
      } else {
        document.getElementById("message").innerText = "Failed to update status";
      }
    }

    async function loadAgents() {
      const res = await fetch("http://localhost:8080/api/users", {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      const agents = data.content.filter(u => u.role.name === "ICT_AGENT");

      const agentSelect = document.getElementById("agentSelect");
      agentSelect.innerHTML = `<option value="">Unassign</option>`;
      agents.forEach(a => {
        agentSelect.innerHTML += `<option value="${a.id}">${a.firstName} ${a.lastName}</option>`;
      });
    }

    async function assignTicket() {
      const agentId = document.getElementById("agentSelect").value || null;

      const res = await fetch(`http://localhost:8080/api/tickets/${ticketId}/assign`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ agentId })
      });

      if (res.ok) {
        document.getElementById("message").innerText = "Ticket assigned successfully!";
        loadTicket();
      } else {
        document.getElementById("message").innerText = "Failed to assign ticket";
      }
    }

    function logout() {
      localStorage.clear();
    }

    loadTicket();
</script>
</body>
</html>