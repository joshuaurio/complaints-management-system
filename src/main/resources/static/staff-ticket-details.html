<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Details</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Basic styling for the gallery items */
        .gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .gallery-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            width: 200px;
            text-align: center;
        }

        .gallery-item img, .gallery-item video {
            max-width: 100%;
            max-height: 150px;
            margin-bottom: 10px;
        }

        .gallery-item button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .gallery-item button:hover {
            background-color: #45a049;
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: #888;
        }

        .loading {
            padding: 20px;
            text-align: center;
            color: #555;
        }

        .error {
            padding: 20px;
            text-align: center;
            color: #d32f2f;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .ticket-info {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .attachment-section {
            margin-bottom: 30px;
        }

        .comment-section {
            margin-bottom: 30px;
        }

        .comment {
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        nav {
            background-color: #333;
            padding: 15px;
            margin-bottom: 30px;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            padding: 10px;
        }

        nav a:hover {
            background-color: #555;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="system-name">IT Support Ticket System</div>
<nav>
    <a href="staff-create-ticket.html">Create Ticket</a> |
    <a href="staff-view-tickets.html">View My Tickets</a> |
    <a href="profile.html">Profile</a> |
    <a href="login.html" onclick="logout()">Logout</a>
</nav>

<div class="container">
    <div class="ticket-info">
        <h2 id="ticketTitle">Loading ticket details...</h2>
        <p><b>Description:</b> <span id="ticketDescription">Loading...</span></p>
        <p><b>Priority:</b> <span id="ticketPriority">Loading...</span></p>
        <p><b>Status:</b> <span id="ticketStatus">Loading...</span></p>
        <p><b>Assigned To:</b> <span id="assignedTo">Loading...</span></p>
        <p><b>Created At:</b> <span id="createdAt">Loading...</span></p>
    </div>

    <div class="attachment-section">
        <h3>Images</h3>
        <div id="imagesGallery" class="gallery">
            <div class="loading">Loading images...</div>
        </div>
    </div>

    <div class="attachment-section">
        <h3>PDFs</h3>
        <div id="pdfsGallery" class="gallery">
            <div class="loading">Loading PDFs...</div>
        </div>
    </div>

    <div class="attachment-section">
        <h3>Videos</h3>
        <div id="videosGallery" class="gallery">
            <div class="loading">Loading videos...</div>
        </div>
    </div>

    <div class="attachment-section" id="otherFilesSection" style="display: none;">
        <h3>Other Files</h3>
        <div id="otherFilesGallery" class="gallery"></div>
    </div>

    <div class="comment-section">
        <h3>Comments</h3>
        <div id="commentsList"></div>
        <textarea id="newComment" placeholder="Add a comment..."></textarea>
        <button onclick="addComment()">Add Comment</button>
    </div>
</div>

<script>
    // Configuration
    const API_BASE = "http://localhost:8080/api"; // Adjusted to match backend
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("userId");
    const ticketId = localStorage.getItem("selectedTicketId");

    // Object URL cache for cleanup
    const objectUrls = [];

    // Check authentication
    if (!token || !ticketId) {
        window.location.href = "login.html";
    }

    async function loadTicketDetails() {
        try {
            showLoadingState();

            // Fetch ticket, attachments, and comments in parallel
            const [ticketRes, attachmentsRes, commentsRes] = await Promise.all([
                fetch(`${API_BASE}/tickets/${ticketId}`, {
                    headers: { "Authorization": "Bearer " + token }
                }),
                fetch(`${API_BASE}/attachments/ticket/${ticketId}`, {
                    headers: { "Authorization": "Bearer " + token }
                }),
                fetch(`${API_BASE}/ticket-comments/ticket/${ticketId}`, {
                    headers: { "Authorization": "Bearer " + token }
                })
            ]);

            if (!ticketRes.ok) throw new Error("Failed to load ticket");
            if (!attachmentsRes.ok) throw new Error("Failed to load attachments");
            if (!commentsRes.ok) throw new Error("Failed to load comments");

            const ticket = await ticketRes.json();
            const attachments = await attachmentsRes.json();
            const comments = await commentsRes.json();

            // Update ticket details
            document.getElementById("ticketTitle").innerText = ticket.title;
            document.getElementById("ticketDescription").innerText = ticket.description;
            document.getElementById("ticketPriority").innerText = ticket.priority ? ticket.priority.name : "-";
            document.getElementById("ticketStatus").innerText = ticket.status ? ticket.status.name : "-";
            document.getElementById("assignedTo").innerText = ticket.assignedAgent ? ticket.assignedAgent.firstName + " " + ticket.assignedAgent.lastName : "Unassigned";
            document.getElementById("createdAt").innerText = ticket.createdAt ? new Date(ticket.createdAt).toLocaleString() : "-";

            // Process attachments
            await processAttachments(attachments);

            // Process comments
            processComments(comments);

        } catch (err) {
            console.error("Error loading ticket:", err);
            showError("Error loading ticket details. Please try again.");
        }
    }

    async function processAttachments(attachments) {
        const galleries = {
            images: document.getElementById("imagesGallery"),
            pdfs: document.getElementById("pdfsGallery"),
            videos: document.getElementById("videosGallery"),
            other: document.getElementById("otherFilesGallery")
        };

        // Clear loading states
        Object.values(galleries).forEach(gallery => {
            if (gallery) gallery.innerHTML = "";
        });

        if (!attachments || attachments.length === 0) {
            galleries.images.innerHTML = "<div class='empty-state'>No images found</div>";
            galleries.pdfs.innerHTML = "<div class='empty-state'>No PDFs found</div>";
            galleries.videos.innerHTML = "<div class='empty-state'>No videos found</div>";
            return;
        }

        // Process each attachment
        for (let attachment of attachments) {
            try {
                const fileName = attachment.originalFileName.toLowerCase();
                const cleanFileName = escapeHtml(attachment.originalFileName);

                const item = document.createElement("div");
                item.className = "gallery-item";
                item.dataset.attachmentId = attachment.id;

                if (fileName.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i)) {
                    // For images
                    const previewRes = await fetch(`${API_BASE}/attachments/${attachment.id}/preview`, {
                        headers: { "Authorization": "Bearer " + token }
                    });

                    if (previewRes.ok) {
                        const blob = await previewRes.blob();
                        const url = URL.createObjectURL(blob);
                        objectUrls.push(url);

                        item.innerHTML = `
                            <h4 title="${cleanFileName}">${truncateFileName(cleanFileName, 20)}</h4>
                            <img src="${url}" alt="${cleanFileName}">
                            <button onclick="downloadAttachment('${attachment.id}', '${cleanFileName.replace(/'/g, "\\'")}')">Download</button>
                        `;
                    } else {
                        item.innerHTML = `
                            <h4 title="${cleanFileName}">${truncateFileName(cleanFileName, 20)}</h4>
                            <p>Preview unavailable</p>
                            <button onclick="downloadAttachment('${attachment.id}', '${cleanFileName.replace(/'/g, "\\'")}')">Download</button>
                        `;
                    }
                    galleries.images.appendChild(item);
                } else if (fileName.match(/\.(pdf)$/i)) {
                    item.innerHTML = `
                        <h4 title="${cleanFileName}">${truncateFileName(cleanFileName, 20)}</h4>
                        <div style="width:100%; height:150px; background:#f0f0f0; display:flex; align-items:center; justify-content:center; margin-bottom:10px;">
                            <span style="font-size:48px;">ðŸ“„</span>
                        </div>
                        <button onclick="downloadAttachment('${attachment.id}', '${cleanFileName.replace(/'/g, "\\'")}')">Download</button>
                    `;
                    galleries.pdfs.appendChild(item);
                } else if (fileName.match(/\.(mp4|webm|ogg|mov|avi|wmv)$/i)) {
                    item.innerHTML = `
                        <h4 title="${cleanFileName}">${truncateFileName(cleanFileName, 20)}</h4>
                        <div style="width:100%; height:150px; background:#f0f0f0; display:flex; align-items:center; justify-content:center; margin-bottom:10px;">
                            <span style="font-size:48px;">ðŸŽ¬</span>
                        </div>
                        <button onclick="downloadAttachment('${attachment.id}', '${cleanFileName.replace(/'/g, "\\'")}')">Download</button>
                        <button onclick="previewVideo('${attachment.id}', this)" style="margin-top:5px; background-color:#2196F3;">Preview</button>
                    `;
                    galleries.videos.appendChild(item);
                } else {
                    document.getElementById("otherFilesSection").style.display = "block";
                    item.innerHTML = `
                        <h4 title="${cleanFileName}">${truncateFileName(cleanFileName, 20)}</h4>
                        <p>File type: ${getFileExtension(cleanFileName).toUpperCase()}</p>
                        <button onclick="downloadAttachment('${attachment.id}', '${cleanFileName.replace(/'/g, "\\'")}')">Download</button>
                    `;
                    galleries.other.appendChild(item);
                }
            } catch (error) {
                console.error("Error processing attachment:", error);
            }
        }

        // Handle empty galleries
        if (galleries.images.children.length === 0) galleries.images.innerHTML = "<div class='empty-state'>No images found</div>";
        if (galleries.pdfs.children.length === 0) galleries.pdfs.innerHTML = "<div class='empty-state'>No PDFs found</div>";
        if (galleries.videos.children.length === 0) galleries.videos.innerHTML = "<div class='empty-state'>No videos found</div>";
    }

    function processComments(comments) {
        const list = document.getElementById("commentsList");
        list.innerHTML = "";
        if (!comments || comments.length === 0) {
            list.innerHTML = "<div class='empty-state'>No comments yet</div>";
            return;
        }

        comments.forEach(c => {
            const commentDiv = document.createElement("div");
            commentDiv.className = "comment";
            commentDiv.innerHTML = `
                <b>${c.author.firstName} ${c.author.lastName}:</b> ${escapeHtml(c.content)} <i>(${new Date(c.createdAt).toLocaleString()})</i>
            `;
            list.appendChild(commentDiv);
        });
    }

    async function addComment() {
        const content = document.getElementById("newComment").value.trim();
        if (!content) return;

        try {
            const res = await fetch(`${API_BASE}/ticket-comments`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                    ticketId: ticketId,
                    authorId: userId,
                    content: content,
                    isInternal: false
                })
            });

            if (!res.ok) throw new Error("Failed to add comment");

            document.getElementById("newComment").value = "";
            loadTicketDetails(); // Reload to update comments
        } catch (err) {
            showError(err.message);
        }
    }

    async function downloadAttachment(attachmentId, filename) {
        try {
            const response = await fetch(`${API_BASE}/attachments/${attachmentId}/download`, {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!response.ok) throw new Error("Failed to download file");

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            objectUrls.push(url);

            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            setTimeout(() => URL.revokeObjectURL(url), 100);
        } catch (error) {
            console.error("Error downloading file:", error);
            alert("Failed to download file. Please try again.");
        }
    }

    async function previewVideo(attachmentId, button) {
        try {
            const item = button.parentElement;
            const videoContainer = item.querySelector("div");

            videoContainer.innerHTML = "<span>Loading...</span>";

            const response = await fetch(`${API_BASE}/attachments/${attachmentId}/preview`, {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!response.ok) throw new Error("Failed to load video");

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            objectUrls.push(url);

            videoContainer.innerHTML = `
                <video controls style="width:100%; height:150px; object-fit:contain;">
                    <source src="${url}" type="video/mp4">
                    Your browser does not support video playback.
                </video>
            `;

            button.style.display = "none";
        } catch (error) {
            console.error("Error loading video:", error);
            button.parentElement.querySelector("div").innerHTML = "<span>Failed to load video</span>";
        }
    }

    function showLoadingState() {
        // Similar to provided
        document.getElementById("ticketTitle").innerText = "Loading ticket details...";
        // ... other loading
        document.getElementById("commentsList").innerHTML = "<div class='loading'>Loading comments...</div>";
    }

    function showError(message) {
        document.querySelector(".container").innerHTML = `
            <div class="error">
                <h2>Error</h2>
                <p>${message}</p>
                <button onclick="window.location.reload()">Try Again</button>
            </div>
        `;
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function truncateFileName(name, maxLength) {
        if (name.length <= maxLength) return name;
        return name.substring(0, maxLength) + '...';
    }

    function getFileExtension(filename) {
        return filename.split('.').pop();
    }

    function logout() {
        objectUrls.forEach(url => URL.revokeObjectURL(url));
        localStorage.clear();
        window.location.href = "login.html";
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadTicketDetails();

        window.addEventListener('beforeunload', () => {
            objectUrls.forEach(url => URL.revokeObjectURL(url));
        });
    });
</script>
</body>
</html>