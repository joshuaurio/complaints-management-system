<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Administrator - View Tickets</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="system-name">IT Support Ticket System</div>
<nav>
    <a href="administrator-create-ticket.html">Create Ticket</a> |
    <a href="administrator-view-tickets.html" class="active">View Tickets</a> |
    <a href="admin-user-management.html">User Management</a> |
    <a href="admin-department-management.html">Department Management</a> |
    <a href="profile.html">Profile</a> |
    <a href="login.html" onclick="logout()">Logout</a>
</nav>

<div class="container">
    <h2>All Tickets</h2>
    <table border="1">
        <thead>
        <tr>
            <th>No.</th>
            <th>Title</th>
            <th>Category</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Created By</th>
            <th>Assigned To</th>
            <th>Created Date</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="ticketTable"></tbody>
    </table>
</div>

<script>
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    if (!token || role !== "ADMINISTRATOR") window.location.href = "login.html";

    async function loadTickets() {
        try {
            const res = await fetch("http://localhost:8080/api/tickets", {
                headers: { "Authorization": "Bearer " + token }
            });
            const data = await res.json();
            const tbody = document.getElementById("ticketTable");
            tbody.innerHTML = "";
            let counter = 1;

            data.content.forEach(t => {
                const assignedTo = t.assignedAgent ? t.assignedAgent.firstName + " " + t.assignedAgent.lastName : "Unassigned";
                tbody.innerHTML += `
                    <tr>
                        <td>${counter++}</td>
                        <td>${t.title}</td>
                        <td>${t.category ? t.category.name : "-"}</td>
                        <td>${t.priority ? t.priority.name : "-"}</td>
                        <td>${t.status ? t.status.name : "-"}</td>
                        <td>${t.createdBy ? t.createdBy.firstName + " " + t.createdBy.lastName : "-"}</td>
                        <td>${assignedTo}</td>
                        <td>${t.createdAt ? new Date(t.createdAt).toLocaleString() : "-"}</td>
                        <td>
                            <button onclick="openTicket(${t.id})">Open</button>
                            <select id="agentSelect_${t.id}"></select>
                            <button onclick="assignTicket(${t.id})">Assign</button>
                        </td>
                    </tr>`;
            });

            // Load agents for each select
            await loadAgentsForSelects(data.content.map(t => t.id));
        } catch (err) {
            console.error(err);
        }
    }

    async function loadAgentsForSelects(ticketIds) {
        try {
            const res = await fetch("http://localhost:8080/api/users", {
                headers: { "Authorization": "Bearer " + token }
            });
            const data = await res.json();
            const agents = data.content.filter(u => u.role.name === "ICT_AGENT");

            ticketIds.forEach(id => {
                const select = document.getElementById(`agentSelect_${id}`);
                select.innerHTML = `<option value="">Unassign</option>`;
                agents.forEach(a => {
                    select.innerHTML += `<option value="${a.id}">${a.firstName} ${a.lastName}</option>`;
                });
            });
        } catch (err) {
            console.error(err);
        }
    }

    async function assignTicket(ticketId) {
        const agentId = document.getElementById(`agentSelect_${ticketId}`).value || null;
        try {
            const res = await fetch(`http://localhost:8080/api/tickets/${ticketId}/assign`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ agentId })
            });
            if (!res.ok) throw new Error("Failed to assign ticket");

            alert("Ticket assigned successfully!");
            loadTickets();
        } catch (err) {
            alert(err.message);
        }
    }

    function openTicket(ticketId) {
        localStorage.setItem("selectedTicketId", ticketId);
        window.location.href = "administrator-ticket-details.html";
    }

    function logout() { localStorage.clear(); }

    loadTickets();
</script>
</body>
</html>